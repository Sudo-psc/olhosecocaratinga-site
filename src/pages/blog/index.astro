---
import Layout from '../../layouts/Layout.astro';
import { client, urlFor, type SanityPost } from '../../lib/sanity';
import groq from 'groq';

let posts: SanityPost[] = [];
let usingSanity = false;

// Fallback content (Static) if Sanity is not connected
const staticPosts = [
  {
    title: "Mitos e Verdades sobre o Olho Seco",
    slug: { current: "mitos-e-verdades" },
    publishedAt: "2024-10-15",
    excerpt: "Voc√™ sabia que olhos lacrimejando podem ser sinal de olho seco? Desvendamos os principais mitos com base na ci√™ncia.",
    mainImage: null, // Static handling below
    staticImage: "/heroeye.png",
    isStatic: true
  },
  {
    title: "Telas e Seus Olhos: Uma Rela√ß√£o Perigosa?",
    slug: { current: "telas-e-olho-seco" },
    publishedAt: "2024-10-10",
    excerpt: "O uso excessivo de celulares e computadores est√° criando uma epidemia de olho seco. Entenda o porqu√™ e como se proteger.",
    mainImage: null,
    staticImage: "/heroeye.png",
    isStatic: true
  }
];

try {
  if (import.meta.env.PUBLIC_SANITY_PROJECT_ID) {
    posts = await client.fetch(groq`*[_type == "post" && defined(slug.current)] | order(publishedAt desc) {
      _id,
      title,
      slug,
      mainImage,
      publishedAt,
      excerpt,
      categories[]->{title}
    }`);
    usingSanity = true;
  }
} catch (e) {
  console.warn("Sanity connection failed or not configured. Using static content.");
}

const displayPosts = usingSanity && posts.length > 0 ? posts : staticPosts;
---

<Layout title="Blog | Olho Seco Caratinga" description="Artigos e novidades sobre sa√∫de ocular e tratamentos.">
  <section class="section-padding bg-gray-50 min-h-screen">
    <div class="container mx-auto px-6">
      <div class="text-center max-w-3xl mx-auto mb-16">
        <span class="text-blue-600 font-bold uppercase tracking-widest text-sm">Conhecimento</span>
        <h1 class="text-4xl md:text-5xl font-bold text-[#003D7A] mt-4 mb-6">Blog Saraiva Vision</h1>
        <p class="text-lg text-gray-600 leading-relaxed mb-4">
          Informa√ß√£o de qualidade baseada em evid√™ncias cient√≠ficas para voc√™ cuidar melhor da sua vis√£o.
        </p>
        {!usingSanity && (
            <div class="inline-block bg-yellow-100 text-yellow-800 text-xs px-3 py-1 rounded-full border border-yellow-200">
                Visualizando conte√∫do demonstrativo (Sanity n√£o configurado)
            </div>
        )}
      </div>

      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
        {displayPosts.map((post: any) => (
          <article class="bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 flex flex-col h-full group border border-gray-100">
             <a href={`/blog/${post.slug.current}`} class="h-56 overflow-hidden block bg-blue-100 relative">
                <div class="absolute inset-0 bg-blue-900/10 group-hover:bg-transparent transition-colors z-10"></div>
                {post.mainImage || post.staticImage ? (
                    <img 
                    src={post.isStatic ? post.staticImage : (urlFor(post.mainImage)?.width(600).url() || '/heroeye.png')} 
                    alt={post.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
                    />
                ) : (
                    <div class="w-full h-full flex items-center justify-center bg-gray-200 text-gray-400">
                        <span class="text-4xl">üì∞</span>
                    </div>
                )}
             </a>
            <div class="p-8 flex-1 flex flex-col">
              <div class="mb-4 flex items-center justify-between text-sm text-gray-400 font-medium">
                <span>{post.publishedAt ? new Date(post.publishedAt).toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' }) : 'Data indefinida'}</span>
                {post.categories && post.categories.length > 0 && (
                    <span class="text-blue-500 bg-blue-50 px-2 py-1 rounded text-xs">
                        {post.categories[0].title}
                    </span>
                )}
              </div>
              <h2 class="text-2xl font-bold text-[#003D7A] mb-4 group-hover:text-blue-600 transition-colors leading-tight line-clamp-2">
                <a href={`/blog/${post.slug.current}`}>{post.title}</a>
              </h2>
              <p class="text-gray-600 mb-6 flex-1 line-clamp-3 leading-relaxed text-sm">
                {post.excerpt}
              </p>
              <a href={`/blog/${post.slug.current}`} class="inline-flex items-center text-blue-600 font-bold hover:text-blue-800 transition-colors uppercase text-sm tracking-wide mt-auto">
                Ler Artigo
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </a>
            </div>
          </article>
        ))}
      </div>
    </div>
  </section>
</Layout>
